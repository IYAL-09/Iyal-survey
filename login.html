<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Iyal Surveys - Login</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<style>
body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to bottom right, #e8f5e9, #c8e6c9); margin:0; padding:20px;}
.container { max-width:400px; margin:auto; background:white; padding:25px; border-radius:12px; box-shadow:0 0 10px #ccc;}
.logo { text-align:center; margin-bottom:15px;}
.logo img { width:90px; height:90px; border-radius:50%; border:4px solid white; object-fit:cover;}
h2 { text-align:center; color:#2e7d32; margin-bottom:20px;}
.input-group { position:relative; margin-bottom:20px;}
.input-group i.fa { position:absolute; top:50%; left:12px; transform:translateY(-50%); color:#4caf50; font-size:1.1em;}
.input-group input { width:100%; padding:10px 38px; border:1px solid #ccc; border-radius:8px; font-size:1em; box-sizing:border-box;}
.eye-toggle { position:absolute; top:50%; right:12px; transform:translateY(-50%); cursor:pointer; color:#4caf50;}
button { width:100%; padding:12px; background:#2e7d32; color:white; border:none; border-radius:8px; font-size:1em; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;}
button:disabled { background:#9e9e9e; cursor:not-allowed;}
.spinner { border:3px solid #f3f3f3; border-top:3px solid white; border-radius:50%; width:18px; height:18px; animation:spin 1s linear infinite; display:none;}
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
#status { text-align:center; margin-top:10px; color:red;}
</style>
</head>
<body>
<div class="container">
  <div class="logo"><img src="iyallogo.png" alt="Logo"/></div>
  <h2>Login</h2>

  <div class="input-group">
    <i class="fa fa-envelope"></i>
    <input type="email" id="email" placeholder="Email" />
  </div>
  <div class="input-group">
    <i class="fa fa-lock"></i>
    <input type="password" id="password" placeholder="Password" />
    <span class="eye-toggle" onclick="togglePassword()"><i class="fa fa-eye" id="eyeIcon"></i></span>
  </div>

  <div class="g-recaptcha" data-sitekey="6Lf22SosAAAAADDRkt-YuGTX57eNEXjYSWfJJOHz"></div>

  <button id="loginBtn" onclick="login()">
    <span id="btnText">Login</span>
    <div class="spinner" id="spinner"></div>
  </button>

  <p id="status"></p>
</div>

<script type="module">
const emailEl = document.getElementById("email");
const passEl = document.getElementById("password");
const statusEl = document.getElementById("status");
const spinner = document.getElementById("spinner");
const btnText = document.getElementById("btnText");
const loginBtn = document.getElementById("loginBtn");

window.togglePassword = function() {
  const eye = document.getElementById("eyeIcon");
  if(passEl.type === "password"){ passEl.type="text"; eye.classList.replace("fa-eye","fa-eye-slash"); }
  else { passEl.type="password"; eye.classList.replace("fa-eye-slash","fa-eye"); }
};

window.login = async function(){
  const email = emailEl.value.trim();
  const password = passEl.value.trim();
  const recaptchaToken = grecaptcha.getResponse();

  if(!email || !password){ statusEl.textContent="Enter email and password"; statusEl.style.color="red"; return; }
  if(!recaptchaToken){ statusEl.textContent="Complete the captcha"; statusEl.style.color="red"; return; }

  spinner.style.display="inline-block";
  btnText.textContent="Logging in...";
  loginBtn.disabled = true;
  statusEl.textContent="";

  try{
    const res = await fetch("https://xkshzlfducmnglxfnxzk.supabase.co/functions/v1/smooth-processor",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({email,password,recaptcha_token:recaptchaToken})
    });
    const data = await res.json();

    if(data.success){
      localStorage.setItem("userSession", JSON.stringify(data.session));
      localStorage.setItem("userInfo", JSON.stringify(data.user));
      statusEl.textContent="Login successful!";
      statusEl.style.color="green";
      setTimeout(()=> window.location.href="dashboard.html", 1200);
    } else {
      throw new Error(data.message);
    }

  } catch(err){
    statusEl.textContent="‚ùå " + err.message;
    statusEl.style.color="red";
  } finally{
    spinner.style.display="none";
    btnText.textContent="Login";
    loginBtn.disabled = false;
    grecaptcha.reset();
  }
};
</script>
</body>
</html>
