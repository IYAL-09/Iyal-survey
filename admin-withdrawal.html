<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Withdrawal Requests | Iyal Surveys Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body class="bg-gradient-to-br from-blue-700 to-red-700 min-h-screen text-white font-sans">

  <!-- Header -->
  <header class="bg-white/15 backdrop-blur-md shadow-md py-4 text-center font-bold text-xl">
    ðŸ’µ Withdrawal Requests
  </header>

  <!-- Container -->
  <div class="container mx-auto p-4">

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full border-collapse">
        <thead class="bg-white/20">
          <tr>
            <th class="px-4 py-2 text-left">User</th>
            <th class="px-4 py-2 text-left">Type</th>
            <th class="px-4 py-2 text-left">Details</th>
            <th class="px-4 py-2 text-left">Amount</th>
            <th class="px-4 py-2 text-left">Requested At</th>
            <th class="px-4 py-2 text-left">Action</th>
          </tr>
        </thead>
        <tbody id="withdrawalsTable" class="divide-y divide-white/20">
          <tr><td colspan="6" class="text-center py-4">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Logout Button -->
    <div class="mt-6 text-center">
      <button id="logoutBtn" class="bg-red-700 hover:bg-red-800 px-6 py-2 rounded font-bold text-white">
        <i class="fa fa-sign-out"></i> Logout
      </button>
    </div>

  </div>

  <script>
    const FUNCTION_URL = "https://xkshzlfducmnglxfnxzk.supabase.co/functions/v1/smart-action";

    // Security: redirect if not logged in
    const adminSession = localStorage.getItem("adminSession");
    if(!adminSession) window.location.href = "admin-login.html";

    document.getElementById("logoutBtn").addEventListener("click", ()=>{
      localStorage.removeItem("adminSession");
      window.location.href = "admin-login.html";
    });

    // Load withdrawals
    async function loadWithdrawals() {
      try {
        const res = await fetch(FUNCTION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "fetch" })
        });
        const data = await res.json();
        const tbody = document.getElementById("withdrawalsTable");

        if(!data.success || !data.withdrawals.length){
          tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4">No pending withdrawals</td></tr>`;
          return;
        }

        // Pending requests first
        data.withdrawals.sort((a, b) => {
          if (a.status === "pending" && b.status !== "pending") return -1;
          if (a.status !== "pending" && b.status === "pending") return 1;
          return new Date(a.created_at) - new Date(b.created_at);
        });

        tbody.innerHTML = "";
        data.withdrawals.forEach(w => {
          const detailHtml = w.type === "bank"
            ? `Account Name: ${w.details.account_name}<br>Account Number: ${w.details.account_number}<br>Bank: ${w.details.bank}`
            : `Network: ${w.details.network}<br>Phone: ${w.details.phone_number}`;

          const actionHtml = w.status === "pending"
            ? `<button class="approve bg-green-600 hover:bg-green-700 px-3 py-1 rounded mr-2" onclick="updateStatus('${w.id}','approved')">Approve</button>
               <button class="decline bg-red-600 hover:bg-red-700 px-3 py-1 rounded" onclick="updateStatus('${w.id}','declined')">Decline</button>`
            : `<span class="font-bold ${w.status === 'approved' ? 'text-green-400' : 'text-red-400'}">${w.status.toUpperCase()}</span>`;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="px-4 py-2">${w.users?.email || w.user_id}</td>
            <td class="px-4 py-2">${w.type}</td>
            <td class="px-4 py-2">${detailHtml}</td>
            <td class="px-4 py-2">â‚¦${w.amount}</td>
            <td class="px-4 py-2">${new Date(w.created_at).toLocaleString()}</td>
            <td class="px-4 py-2">${actionHtml}</td>
          `;
          tbody.appendChild(row);
        });

      } catch(err) {
        console.error(err);
        document.getElementById("withdrawalsTable").innerHTML = `<tr><td colspan="6" class="text-center py-4">Error loading withdrawals</td></tr>`;
      }
    }

    // Approve/Decline withdrawal
    async function updateStatus(id, status){
      try {
        const res = await fetch(FUNCTION_URL, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ action: "update", id, status })
        });
        const data = await res.json();
        if(data.success) loadWithdrawals();
        else alert("Failed to update status");
      } catch(err){
        console.error(err);
        alert("Error updating status");
      }
    }

    loadWithdrawals();
  </script>

</body>
</html>
