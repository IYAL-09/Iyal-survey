<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Referrals - Iyal Surveys</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    /* Circle logo with white border */
    .logo-circle {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 4px solid white;
      object-fit: cover;
    }
  </style>
</head>
<body class="bg-green-50 font-sans">

  <!-- Header -->
  <header class="bg-green-800 text-white flex items-center justify-between p-4 relative">
    <div class="flex items-center">
      <img src="assets/iyallogo.png" alt="Iyal Logo" class="logo-circle mr-3" />
      <span class="text-xl font-bold">Iyal Surveys</span>
    </div>
    <div class="text-2xl cursor-pointer" onclick="toggleMenu()">
      <i class="fa fa-bars"></i>
    </div>
    <nav id="menu" class="absolute right-4 top-16 bg-green-700 rounded-lg shadow-lg flex-col hidden">
      <a href="dashboard.html" class="block px-4 py-2 hover:bg-green-600">Dashboard</a>
      <a href="terms.html" class="block px-4 py-2 hover:bg-green-600">Terms & Conditions</a>
      <a href="privacy.html" class="block px-4 py-2 hover:bg-green-600">Privacy Policy</a>
      <a href="support.html" class="block px-4 py-2 hover:bg-green-600">Support</a>
      <a href="login.html" class="block px-4 py-2 hover:bg-green-600">Logout</a>
    </nav>
  </header>

  <!-- Balance & Referral Code -->
  <div class="p-4">
    <div class="bg-white rounded-xl shadow-md p-4 mb-4 text-center">
      <h2 class="text-green-800 font-bold text-lg">Your Balance</h2>
      <p id="balanceDisplay" class="text-gray-700 mt-2 text-lg">
        <i class="fa fa-spinner fa-spin"></i> Loading balance...
      </p>
    </div>

    <div class="bg-white rounded-xl shadow-md p-4 mb-4 text-center">
      <h2 class="text-green-800 font-bold text-lg">Your Referral Code</h2>
      <p id="referralCode" class="text-gray-700 mt-2 text-lg">
        <i class="fa fa-spinner fa-spin"></i> Loading code...
      </p>
      <button class="bg-green-800 text-white px-4 py-2 rounded mt-3 hover:bg-green-700" onclick="copyReferralCode()">
        <i class="fa fa-copy"></i> Copy Code
      </button>
    </div>
  </div>

  <!-- Referral Tables -->
  <div id="tablesContainer" class="p-4 space-y-4"></div>

  <!-- Bottom Nav -->
  <div class="fixed bottom-0 w-full bg-green-800 flex justify-around text-white py-2 shadow-inner">
    <a href="withdraw.html" class="text-center">
      <i class="fa fa-money-bill-wave block text-lg"></i>
      Cash Out
    </a>
    <a href="referrals.html" class="text-center">
      <i class="fa fa-users block text-lg"></i>
      Referrals
    </a>
    <a href="dashboard.html" class="text-center">
      <i class="fa fa-home block text-lg"></i>
      Dashboard
    </a>
    <a href="login.html" class="text-center">
      <i class="fa fa-sign-out-alt block text-lg"></i>
      Logout
    </a>
  </div>

  <script>
    function toggleMenu() {
      const menu = document.getElementById("menu");
      menu.classList.toggle("hidden");
    }

    function copyReferralCode() {
      const codeText = document.getElementById("referralCode").textContent.trim();
      if (codeText && !codeText.includes("Loading")) {
        navigator.clipboard.writeText(codeText).then(() => alert("Referral code copied!"));
      }
    }
  </script>

  <script type="module">
    const API_URL = "https://xkshzlfducmnglxfnxzk.supabase.co/functions/v1/rapid-processor";

    const referralCodeDisplay = document.getElementById("referralCode");
    const balanceDisplay = document.getElementById("balanceDisplay");
    const tablesContainer = document.getElementById("tablesContainer");

    // Get user session from localStorage
    const userSession = JSON.parse(localStorage.getItem("userSession"));
    if (!userSession || !userSession.user) {
      window.location.href = "login.html";
    }

    const userId = userSession.user.id;

    async function loadReferrals() {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "get_referrals", user_id: userId })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        // Display balance & referral code
        balanceDisplay.textContent = `â‚¦${Number(data.balance).toLocaleString()}`;
        referralCodeDisplay.textContent = data.referral_code;

        // Display referral tables (groups of 5)
        tablesContainer.innerHTML = "";
        const tables = data.tables; // Array of referral tables
        if (!tables.length) {
          tablesContainer.innerHTML = "<p class='text-center text-gray-700'>No referrals yet.</p>";
          return;
        }

        tables.forEach((table, index) => {
          const tableDiv = document.createElement("div");
          tableDiv.className = "bg-white p-4 rounded-xl shadow-md";
          tableDiv.innerHTML = `
            <h3 class="font-bold text-green-800 mb-2">Referral Table ${index + 1} - Reward: $${table.reward_amount}</h3>
            <ul class="list-disc pl-5 space-y-1">
              ${table.referrals.map(ref => `<li class="${ref.status === 'rewarded' ? 'text-green-600' : 'text-orange-500'}">${ref.referred_email} - ${ref.status}</li>`).join('')}
            </ul>
          `;
          tablesContainer.appendChild(tableDiv);
        });

      } catch (err) {
        console.error(err);
        balanceDisplay.textContent = "Error loading balance";
        referralCodeDisplay.textContent = "Error loading code";
        tablesContainer.innerHTML = "<p class='text-center text-red-600'>Error loading referrals.</p>";
      }
    }

    loadReferrals();
  </script>
</body>
</html>
