<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Iyal Surveys – Referrals</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body { font-family:'Segoe UI',sans-serif; margin:0; background:#f1f8e9; color:#2e7d32; }
header { background:#2e7d32; color:white; padding:15px; display:flex; align-items:center; justify-content:space-between; position:relative; }
.logo { display:flex; align-items:center; }
.logo img { width:50px; height:50px; border-radius:50%; border:3px solid white; object-fit:cover; margin-right:10px; }
.logo span { font-size:1.2em; font-weight:bold; }
.menu-toggle { font-size:1.5em; cursor:pointer; }
nav { position:absolute; top:60px; right:15px; background:#388e3c; display:none; flex-direction:column; padding:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.3); z-index:10; }
nav a { color:white; text-decoration:none; padding:8px 0; border-bottom:1px solid #66bb6a; }
.content { padding:15px; padding-bottom:120px; }
.card { background:white; padding:18px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; text-align:center; }
.card h2 { margin:0 0 10px; font-size:1.3em; }
.copy-btn { padding:8px 14px; background:#2e7d32; color:white; border:none; border-radius:6px; cursor:pointer; }
.group { background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
.group h3 { margin:0 0 10px; font-size:1.05em; }
.group ul { list-style:none; padding:0; margin:0; }
.group li { padding:6px 0; border-bottom:1px solid #eee; font-size:0.95em; }
.status-complete { color:green; font-weight:bold; margin-top:8px; }
.status-pending { color:orange; font-weight:bold; margin-top:8px; }
.bottom-nav { position:fixed; bottom:0; left:0; width:100%; background:#2e7d32; display:flex; justify-content:space-around; padding:10px 0; box-shadow:0 -2px 5px rgba(0,0,0,0.2); }
.bottom-nav a { color:white; text-decoration:none; font-size:0.9em; text-align:center; }
.bottom-nav i { display:block; font-size:1.2em; margin-bottom:4px; }
.spinner { width:16px; height:16px; border:3px solid #c8e6c9; border-top:3px solid #2e7d32; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; }
@keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="iyallogo.png" alt="Iyal Logo" />
    <span>Iyal Surveys</span>
  </div>
  <div class="menu-toggle" onclick="toggleMenu()"><i class="fa fa-bars"></i></div>
  <nav id="menu">
    <a href="dashboard.html">Dashboard</a>
    <a href="terms.html">Terms</a>
    <a href="privacy.html">Privacy</a>
    <a href="support.html">Support</a>
  </nav>
</header>

<div class="content">
  <div class="card">
    <h2>Your Balance</h2>
    <p id="balance"><span class="spinner"></span></p>
  </div>

  <div class="card">
    <h2>Your Referral Code</h2>
    <p id="refCode"><span class="spinner"></span></p>
    <button class="copy-btn" onclick="copyCode()"><i class="fa fa-copy"></i> Copy Code</button>
  </div>

  <div id="groups"></div>
</div>

<div class="bottom-nav">
  <a href="withdraw.html"><i class="fa fa-money-bill-wave"></i>Cash Out</a>
  <a href="referrals.html"><i class="fa fa-users"></i>Referrals</a>
  <a href="dashboard.html"><i class="fa fa-home"></i>Dashboard</a>
  <a href="#" id="logout"><i class="fa fa-sign-out-alt"></i>Logout</a>
</div>

<script>
function toggleMenu(){ 
  const m = document.getElementById('menu'); 
  m.style.display = m.style.display==='flex'?'none':'flex'; 
}
function copyCode(){ 
  const c = document.getElementById('refCode').innerText; 
  if(c) navigator.clipboard.writeText(c).then(()=>alert('Copied!')); 
}

document.getElementById('logout').onclick = () => { 
  localStorage.removeItem('userSession'); 
  location.href='login.html'; 
};

async function initReferrals(){
  const sessionStr = localStorage.getItem('userSession');
  if(!sessionStr){ location.href='login.html'; return; }

  const session = JSON.parse(sessionStr);
  const token = session.access_token; // JWT token

  try{
    const res = await fetch('https://xkshzlfducmnglxfnxzk.supabase.co/functions/v1/referral-data',{
      method:'POST', 
      headers:{
        'Content-Type':'application/json',
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await res.json();
    if(!data.success) throw new Error('Failed');

    // Balance & Referral Code
    document.getElementById('balance').innerText = '₦' + data.balance.toLocaleString();
    document.getElementById('refCode').innerText = data.referral_code;

    // Render Referral Groups
    const container = document.getElementById('groups');
    container.innerHTML='';

    const refs = data.referrals || [];
    let groupIndex = 1;

    for(let i=0;i<refs.length;i++){
      const group = refs[i];
      const completed = group.length === 5;

      const div = document.createElement('div');
      div.className='group';
      div.innerHTML = `<h3>Referral Group ${groupIndex}</h3>`;

      const ul = document.createElement('ul');
      group.forEach(r=>{
        const li = document.createElement('li');
        li.textContent = r.referred_email || 'Pending user';
        ul.appendChild(li);
      });
      div.appendChild(ul);

      const status = document.createElement('div');
      status.className = completed ? 'status-complete' : 'status-pending';
      status.textContent = completed ? 'Rewarded: ₦2,201' : 'Pending (need 5 referrals)';
      div.appendChild(status);

      container.appendChild(div);
      groupIndex++;
    }

    if(refs.length===0){ container.innerHTML='<p>No referrals yet.</p>'; }

  }catch(err){
    console.error(err);
    document.getElementById('balance').innerText='Error loading balance';
    document.getElementById('refCode').innerText='Error loading code';
    document.getElementById('groups').innerHTML='<p>Error loading referrals.</p>';
  }
}

initReferrals();
</script>

</body>
</html>
