<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iyal Surveys ‚Äì Referrals</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
/* Your original styles */
body { font-family:'Segoe UI',sans-serif; margin:0; background:#f1f8e9; color:#2e7d32; }
header { background:#2e7d32; color:white; padding:15px; display:flex; align-items:center; justify-content:space-between; position:relative; }
.logo { display:flex; align-items:center; }
.logo img { width:50px; height:50px; border-radius:50%; border:3px solid white; margin-right:10px; }
.menu-toggle { font-size:1.5em; cursor:pointer; }
nav { position:absolute; top:60px; right:15px; background:#388e3c; display:none; flex-direction:column; padding:10px; border-radius:8px; }
nav a { color:white; text-decoration:none; padding:8px 0; }
.content { padding:15px; padding-bottom:120px; }
.card { background:white; padding:18px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; text-align:center; }
.group { background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
.group h3 { margin:0 0 10px; font-size:1.05em; }
.group ul { list-style:none; padding:0; margin:0; }
.group li { padding:6px 0; font-size:0.95em; }
.status-complete { color:green; font-weight:bold; margin-top:8px; }
.status-pending { color:orange; font-weight:bold; margin-top:8px; }
.bottom-nav { position:fixed; bottom:0; left:0; width:100%; background:#2e7d32; display:flex; justify-content:space-around; padding:10px 0; box-shadow:0 -2px 5px rgba(0,0,0,0.2); }
.bottom-nav a { color:white; text-decoration:none; font-size:0.9em; }
.bottom-nav i { display:block; font-size:1.2em; margin-bottom:4px; }
.spinner { width:16px; height:16px; border:3px solid #c8e6c9; border-top:3px solid #2e7d32; border-radius:50%; animation:spin 1s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
</style>

</head>
<body>

<header>
  <div class="logo">
    <img src="iyallogo.png" alt="Iyal Logo"/>
    <span>Iyal Surveys</span>
  </div>
  <div class="menu-toggle" onclick="toggleMenu()"><i class="fa fa-bars"></i></div>
  <nav id="menu">
    <a href="dashboard.html">Dashboard</a>
    <a href="withdraw.html">Cash Out</a>
    <a href="terms.html">Terms</a>
    <a href="privacy.html">Privacy</a>
    <a href="#" id="logout">Logout</a>
  </nav>
</header>

<div class="content">
  <div class="card">
    <h2>Your Balance</h2>
    <p id="balance"><span class="spinner"></span></p>
  </div>

  <div class="card">
    <h2>Your Referral Code</h2>
    <p id="refCode"><span class="spinner"></span></p>
    <button onclick="copyCode()">Copy Code</button>
  </div>

  <!-- Referral Groups & Logic -->
  <div id="referralDescription">
    <h3>Referral System Explained</h3>
    <p>Invite your friends to join! Each time 5 people you refer sign up and complete their surveys, you earn a reward of ‚Ç¶2,201. Here's how it works:</p>
    <ul>
      <li><i class="fa fa-check-circle"></i> Complete 5 referrals.</li>
      <li><i class="fa fa-trophy"></i> Receive ‚Ç¶2,201 for each group of 5 completed referrals.</li>
      <li><i class="fa fa-users"></i> Referrals show up as groups.</li>
    </ul>
  </div>

  <div id="groups"></div>
</div>

<div class="bottom-nav">
  <a href="withdraw.html"><i class="fa fa-money-bill"></i> Cash Out</a>
  <a href="referrals.html"><i class="fa fa-users"></i> Referrals</a>
  <a href="dashboard.html"><i class="fa fa-home"></i> Dashboard</a>
  <a href="#" id="logoutBottom"><i class="fa fa-sign-out-alt"></i> Logout</a>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://xkshzlfducmnglxfnxzk.supabase.co",
  "YOUR_ANON_KEY"
);

// Toggle Menu
window.toggleMenu = () => {
  const m = document.getElementById("menu");
  m.style.display = m.style.display === "flex" ? "none" : "flex";
};

// Copy referral code
function copyCode(){
  const text = document.getElementById("refCode").innerText;
  navigator.clipboard.writeText(text);
}

/* üîê SESSION */
const { data:{ session } } = await supabase.auth.getSession();
if(!session){
  location.href = "login.html";
}

/* üì° FETCH REFERRALS */
const res = await fetch(
  "https://xkshzlfducmnglxfnxzk.supabase.co/functions/v1/bright-worker",
  {
    method:"POST",
    headers:{
      "Authorization":`Bearer ${session.access_token}`,
      "Content-Type":"application/json"
    }
  }
);

const data = await res.json();
if(!data.success){
  alert("Failed to load referrals");
  return;
}

document.getElementById("balance").innerText =
  "‚Ç¶" + Number(data.balance).toLocaleString();
document.getElementById("refCode").innerText = data.referral_code;

const groups = document.getElementById("groups");
groups.innerHTML = "";

// Display referral groups
let i = 1;
for(const group of data.referrals){
  const div = document.createElement("div");
  div.className = "group";
  div.innerHTML = `<h3>Referral Group ${i++}</h3>`;
  group.forEach(r=>{
    div.innerHTML += `<p>${r.referred_email || "Pending user"}</p>`;
  });
  groups.appendChild(div);
}

/* üö™ LOGOUT */
async function logout(){
  await supabase.auth.signOut();
  location.href="login.html";
}
document.getElementById("logout").onclick = logout;
document.getElementById("logoutBottom").onclick = logout;
</script>

</body>
</html>
