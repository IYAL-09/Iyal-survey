<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Register - Iyal Surveys</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<style>
  body {
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background: linear-gradient(to bottom right, #e8f5e9, #c8e6c9);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
  }
  .card {
    background:white;
    border-radius:12px;
    padding:25px;
    max-width:400px;
    width:90%;
    box-shadow:0 4px 20px rgba(0,0,0,0.1);
    animation:fadeIn 0.6s ease;
  }
  @keyframes fadeIn {
    from {opacity:0; transform:translateY(20px);}
    to {opacity:1; transform:translateY(0);}
  }
  .logo { text-align:center; margin-bottom:15px; }
  .logo img {
    width:50px;
    height:50px;
    border-radius:50%;
    border:3px solid white;
    object-fit:cover;
  }
  .logo h1 { margin-top:8px; font-size:1.4em; color:#2e7d32; }
  h2 { text-align:center; color:#2e7d32; margin-bottom:15px; font-size:1.2em; }
  .input-group { position:relative; margin-bottom:15px; }
  input {
    width:100%;
    padding:12px;
    border:1px solid #ccc;
    border-radius:8px;
    font-size:1em;
    box-sizing:border-box;
  }
  .eye-toggle {
    position:absolute;
    top:50%;
    right:12px;
    transform:translateY(-50%);
    cursor:pointer;
    color:#4caf50;
  }
  button {
    width:100%;
    padding:12px;
    background:#2e7d32;
    color:white;
    border:none;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
  }
  button:disabled { background:#9e9e9e; cursor:not-allowed; }
  .spinner {
    display:none;
    width:18px;
    height:18px;
    border:3px solid white;
    border-top:3px solid transparent;
    border-radius:50%;
    animation:spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .message { text-align:center; margin-top:10px; font-weight:bold; }
  .error { color:#d32f2f; }
  .success { color:#2e7d32; }
  .password-checklist {
    list-style:none;
    padding-left:0;
    font-size:0.9em;
    margin-bottom:10px;
  }
  .password-checklist li {
    display:flex;
    align-items:center;
    margin-bottom:5px;
  }
  .password-checklist li i { margin-right:8px; }
  .login-link { text-align:center; margin-top:10px; }
  .login-link a {
    color:#2e7d32;
    font-weight:bold;
    text-decoration:none;
  }
</style>
</head>

<body>

<div class="card">
  <div class="logo">
    <img src="iyallogo.png" alt="Iyal Logo">
    <h1>Iyal Surveys</h1>
  </div>

  <h2>Create Account</h2>

  <form id="registerForm">
    <div class="input-group">
      <input type="text" id="full_name" placeholder="Full Name" required>
    </div>

    <div class="input-group">
      <input type="email" id="email" placeholder="Email" required>
    </div>

    <div class="input-group">
      <input type="password" id="password" placeholder="Password" required>
      <span class="eye-toggle" onclick="togglePassword('password','eye1')">
        <i id="eye1" class="fa fa-eye"></i>
      </span>
    </div>

    <ul class="password-checklist">
      <li id="checkLength"><i class="fa fa-times"></i> Minimum 6 characters</li>
      <li id="checkUpper"><i class="fa fa-times"></i> At least 1 uppercase letter</li>
      <li id="checkNumber"><i class="fa fa-times"></i> At least 1 number</li>
      <li id="checkSpecial"><i class="fa fa-times"></i> At least 1 special character</li>
    </ul>

    <div class="input-group">
      <input type="password" id="confirm_password" placeholder="Confirm Password" required>
      <span class="eye-toggle" onclick="togglePassword('confirm_password','eye2')">
        <i id="eye2" class="fa fa-eye"></i>
      </span>
    </div>

    <input type="text" id="referral_code" placeholder="Referral Code (optional)">

    <div class="g-recaptcha" data-sitekey="6Lf22SosAAAAADDRkt-YuGTX57eNEXjYSWfJJOHz"></div>

    <button type="submit" id="registerBtn">
      Create Account
      <div class="spinner" id="spinner"></div>
    </button>

    <div id="message" class="message"></div>

    <div class="login-link">
      Already have an account? <a href="login.html">Login</a>
    </div>
  </form>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://xkshzlfducmnglxfnxzk.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
const ENDPOINT = "https://xkshzlfducmnglxfnxzk.supabase.co/functions/v1/clever-handler";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const form = document.getElementById("registerForm");
const messageBox = document.getElementById("message");
const spinner = document.getElementById("spinner");
const registerBtn = document.getElementById("registerBtn");

function togglePassword(inputId, iconId){
  const input = document.getElementById(inputId);
  const icon = document.getElementById(iconId);
  if(input.type==="password"){
    input.type="text";
    icon.classList.replace("fa-eye","fa-eye-slash");
  } else {
    input.type="password";
    icon.classList.replace("fa-eye-slash","fa-eye");
  }
}

document.getElementById("password").addEventListener("input", e => {
  const v = e.target.value;
  document.getElementById("checkLength").querySelector("i").className = v.length>=6?"fa fa-check":"fa fa-times";
  document.getElementById("checkUpper").querySelector("i").className = /[A-Z]/.test(v)?"fa fa-check":"fa fa-times";
  document.getElementById("checkNumber").querySelector("i").className = /\d/.test(v)?"fa fa-check":"fa fa-times";
  document.getElementById("checkSpecial").querySelector("i").className = /[^A-Za-z0-9]/.test(v)?"fa fa-check":"fa fa-times";
});

form.addEventListener("submit", async e => {
  e.preventDefault();
  messageBox.textContent = "";
  spinner.style.display = "inline-block";
  registerBtn.disabled = true;

  const full_name = full_name.value.trim();
  const email = email.value.trim();
  const password = password.value;
  const confirm = confirm_password.value;
  const referral_code = referral_code.value.trim() || null;

  if(password !== confirm){
    showError("Passwords do not match");
    return;
  }

  const token = grecaptcha.getResponse();
  if(!token){
    showError("Complete the reCAPTCHA");
    return;
  }

  try {
    const captchaRes = await fetch(ENDPOINT,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ recaptcha_token: token })
    });
    const captcha = await captchaRes.json();
    if(!captcha.success) throw new Error("Captcha verification failed");

    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options:{ data:{ full_name, referral_code } }
    });

    if(error) throw error;

    // üîí CRITICAL FIX
    if(!data.user){
      throw new Error("Email already registered. Please log in.");
    }

    showSuccess("Registration successful! Check your email to verify.");
    setTimeout(()=>location.href="login.html",1500);

  } catch(err){
    showError(err.message);
    grecaptcha.reset();
  }
});

function showError(msg){
  messageBox.textContent = "‚ùå " + msg;
  messageBox.className = "message error";
  spinner.style.display="none";
  registerBtn.disabled=false;
}

function showSuccess(msg){
  messageBox.textContent = "‚úÖ " + msg;
  messageBox.className = "message success";
  spinner.style.display="none";
  registerBtn.disabled=false;
}
</script>

</body>
</html>
