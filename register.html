<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Register - Iyal Surveys</title>

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<!-- Google reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<style>
/* Password strength indicator */
.strength-item { font-size: 0.875rem; margin-top: 2px; display: flex; align-items: center; gap: 6px; }
.strength-item .fa-check { color: green; display: none; }
.strength-item.valid .fa-check { display: inline-block; }
</style>
</head>
<body class="bg-green-50 flex items-center justify-center min-h-screen p-4">

<div class="w-full max-w-md">
  <div class="text-center mb-6">
    <img src="assets/logo.png" class="mx-auto rounded-full border-2 border-white w-12 h-12" />
    <h1 class="mt-2 text-2xl font-bold text-green-800">Iyal Surveys</h1>
  </div>

  <div class="bg-white shadow-lg rounded-xl p-6 space-y-4 animate-fadeIn">
    <form id="registerForm" class="space-y-4">

      <input type="text" id="full_name" placeholder="Full Name" required
        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />

      <input type="email" id="email" placeholder="Email Address" required
        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />

      <div class="relative">
        <input type="password" id="password" placeholder="Password" required
          class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
        <i class="fa fa-eye absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer text-gray-600"
          onclick="togglePassword()"></i>
      </div>

      <!-- Password Strength -->
      <div id="passwordStrength" class="space-y-1">
        <div class="strength-item" id="upper"><i class="fa fa-check"></i> At least 1 uppercase letter</div>
        <div class="strength-item" id="number"><i class="fa fa-check"></i> At least 1 number</div>
        <div class="strength-item" id="special"><i class="fa fa-check"></i> At least 1 special character (^)_+*%$#)</div>
        <div class="strength-item" id="length"><i class="fa fa-check"></i> Minimum 6 characters</div>
      </div>

      <input type="text" id="referral_code" placeholder="Referral Code (optional)"
        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />

      <div class="g-recaptcha" data-sitekey="6Lf22SosAAAAADDRkt-YuGTX57eNEXjYSWfJJOHz"></div>

      <button type="submit" id="registerBtn"
        class="w-full bg-green-700 text-white font-bold py-3 rounded-lg relative disabled:opacity-50 flex justify-center items-center gap-2">
        Create Account
        <div class="spinner border-2 border-white border-t-transparent rounded-full w-5 h-5 hidden"></div>
      </button>

      <div id="message" class="text-center font-semibold mt-2"></div>

      <div class="text-center text-sm">
        Already have an account? <a href="login.html" class="text-green-700 font-bold">Login</a>
      </div>
    </form>
  </div>
</div>

<script type="module">
const ENDPOINT = "https://xkshzlfducmnglxfnxzk.supabase.co/functions/v1/clever-handler";
const form = document.getElementById("registerForm");
const messageBox = document.getElementById("message");
const spinner = document.querySelector(".spinner");
const registerBtn = document.getElementById("registerBtn");
const passwordInput = document.getElementById("password");

// Toggle password visibility
function togglePassword(){
  passwordInput.type = passwordInput.type === "password" ? "text" : "password";
}

// Password Strength Check
const upperEl = document.getElementById("upper");
const numberEl = document.getElementById("number");
const specialEl = document.getElementById("special");
const lengthEl = document.getElementById("length");

passwordInput.addEventListener("input", () => {
  const val = passwordInput.value;
  upperEl.classList.toggle("valid", /[A-Z]/.test(val));
  numberEl.classList.toggle("valid", /[0-9]/.test(val));
  specialEl.classList.toggle("valid", /[\^)_+\*\%\$#]/.test(val));
  lengthEl.classList.toggle("valid", val.length >= 6);
});

form.addEventListener("submit", async e => {
  e.preventDefault();
  messageBox.textContent = "";
  spinner.classList.remove("hidden");
  registerBtn.disabled = true;

  // Validate password strength before sending
  if (!/[A-Z]/.test(passwordInput.value) || !/[0-9]/.test(passwordInput.value) ||
      !/[\^)_+\*\%\$#]/.test(passwordInput.value) || passwordInput.value.length < 6) {
    showError("Password does not meet strength requirements");
    spinner.classList.add("hidden");
    registerBtn.disabled = false;
    return;
  }

  const recaptchaToken = grecaptcha.getResponse();
  if(!recaptchaToken){
    showError("Please complete the reCAPTCHA");
    spinner.classList.add("hidden");
    registerBtn.disabled = false;
    return;
  }

  const payload = {
    full_name: document.getElementById("full_name").value.trim(),
    email: document.getElementById("email").value.trim(),
    password: passwordInput.value,
    referral_code: document.getElementById("referral_code").value.trim() || null,
    recaptcha_token: recaptchaToken
  };

  try {
    const res = await fetch(ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if(!data.success) throw new Error(data.message);

    messageBox.textContent = "✅ Registration successful! Redirecting...";
    messageBox.className = "text-green-700 font-bold mt-2 text-center";

    setTimeout(() => window.location.href="dashboard.html", 1500);

  } catch(err){
    showError(err.message || "Registration failed");
    grecaptcha.reset();
  } finally {
    spinner.classList.add("hidden");
    registerBtn.disabled = false;
  }
});

function showError(msg){
  messageBox.textContent = "❌ " + msg;
  messageBox.className = "text-red-600 font-bold mt-2 text-center";
}
</script>

</body>
</html>
