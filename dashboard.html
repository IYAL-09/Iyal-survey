<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Iyal Surveys â€“ Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body { font-family:'Segoe UI',sans-serif; margin:0; background:#f1f8e9; color:#2e7d32; }
header { background:#2e7d32; color:white; padding:15px; display:flex; justify-content:space-between; }
.balance-card { background:white; padding:20px; margin:20px; border-radius:12px; text-align:center; font-size:1.3em; }
.spinner { width:18px; height:18px; border:3px solid #c8e6c9; border-top:3px solid #2e7d32; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; }
@keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>

<header>
  <div>Iyal Surveys</div>
  <button id="logoutBtn">Logout</button>
</header>

<div class="balance-card">
  Balance: <span id="balance"><span class="spinner"></span></span>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://xkshzlfducmnglxfnxzk.supabase.co",
  "YOUR_ANON_KEY"
);

/* ðŸ” CHECK SESSION */
const {
  data: { session }
} = await supabase.auth.getSession();

if (!session) {
  window.location.href = "login.html";
}

/* ðŸ”„ LOAD BALANCE */
async function loadBalance() {
  const res = await fetch(
    "https://xkshzlfducmnglxfnxzk.supabase.co/functions/v1/rapid-processor",
    {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${session.access_token}`,
        "Content-Type": "application/json"
      }
    }
  );

  const data = await res.json();
  if (data.success) {
    document.getElementById("balance").textContent =
      "â‚¦" + Number(data.balance).toLocaleString();
  } else {
    document.getElementById("balance").textContent = "â‚¦0";
  }
}

loadBalance();

/* ðŸšª LOGOUT */
document.getElementById("logoutBtn").onclick = async () => {
  await supabase.auth.signOut();
  window.location.href = "login.html";
};

/* ðŸ” AUTH STATE */
supabase.auth.onAuthStateChange((event) => {
  if (event === "SIGNED_OUT") {
    window.location.href = "login.html";
  }
});
</script>

</body>
</html>
