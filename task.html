<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ExoClick verification meta tag must be first -->
  <meta name="6a97888e-site-verification" content="d216969116ed26609c5aa5e91b2b2f01">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Iyal Surveys - Tasks</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://vjs.zencdn.net/7.25.0/video-js.css" rel="stylesheet" />
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f1f8e9; }
    header, .bottom-nav { background: #2e7d32; color: white; }
    header { padding: 15px; display: flex; align-items: center; justify-content: space-between; position: relative; }
    .logo { display: flex; align-items: center; }
    .logo img { width: 40px; margin-right: 10px; }
    .logo span { font-size: 1.2em; font-weight: bold; }
    .menu-toggle { font-size: 1.5em; cursor: pointer; }
    nav { position: absolute; top: 60px; right: 15px; background: #388e3c; display: none; flex-direction: column; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10; }
    nav a { color: white; text-decoration: none; padding: 8px 0; border-bottom: 1px solid #66bb6a; }
    .content { padding: 20px; padding-bottom: 100px; }
    .video-box { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 0 10px #ccc; margin-bottom: 20px; text-align: center; position: relative; overflow: hidden; }
    .balance { background: #c8e6c9; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: bold; color: #2e7d32; position: relative; }
    .spinner { border: 4px solid #c8e6c9; border-top: 4px solid #2e7d32; border-radius: 50%; width: 24px; height: 24px; margin: auto; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .popup { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4caf50; color: white; padding: 12px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 0.95em; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.5s ease; z-index: 1000; }
    .popup.show { opacity: 1; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.2); }
    .bottom-nav a { color: white; text-decoration: none; font-size: 0.9em; text-align: center; }
    .bottom-nav i { display: block; font-size: 1.2em; margin-bottom: 4px; }
    .video-js { width: 100%; height: 360px; border-radius: 10px; }
    .countdown { position: absolute; top: 8px; right: 8px; background: #2e7d32; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9em; display: none; z-index: 10; }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="assets/iyallogo.png" alt="Iyal Logo" />
      <span>Iyal Surveys</span>
    </div>
    <div class="menu-toggle" onclick="toggleMenu()"><i class="fa fa-bars"></i></div>
    <nav id="menu">
      <a href="dashboard.html">Dashboard</a>
      <a href="terms.html">Terms & Conditions</a>
      <a href="privacy.html">Privacy Policy</a>
      <a href="support.html">Support Page</a>
    </nav>
  </header>

  <div class="content">
    <div class="balance" id="balanceContainer">
      <div class="spinner" id="balanceSpinner"></div>
      <span id="balance" style="display:none;">Balance: ₦0</span>
    </div>
    <h2>Watch Ads & Earn ₦25 Each</h2>
    <p><strong>Note:</strong> You must watch the full ad to earn ₦25.</p>

    <div class="video-box">
      <div id="countdown" class="countdown">0</div>
      <video
        id="ad-video"
        class="video-js vjs-default-skin"
        controls
        preload="auto"
      ></video>
    </div>
  </div>

  <div class="popup" id="popup"></div>

  <div class="bottom-nav">
    <a href="withdraw.html"><i class="fa fa-money-bill-wave"></i>Cash Out</a>
    <a href="referrals.html"><i class="fa fa-users"></i>Referrals</a>
    <a href="dashboard.html"><i class="fa fa-home"></i>Dashboard</a>
    <a href="login.html"><i class="fa fa-sign-out-alt"></i>Logout</a>
  </div>

  <script>
    function toggleMenu() {
      const menu = document.getElementById("menu");
      menu.style.display = menu.style.display === "flex" ? "none" : "flex";
    }

    function showPopup(msg) {
      const popup = document.getElementById("popup");
      popup.innerHTML = `<i class='fa fa-check-circle'></i> ${msg}`;
      popup.classList.add("show");
      setTimeout(() => popup.classList.remove("show"), 2500);
    }
  </script>

  <!-- Video.js + Firebase scripts -->
  <script src="https://vjs.zencdn.net/7.25.0/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-ads@6.9.0/dist/videojs-contrib-ads.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ima@1.9.0/dist/videojs.ima.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
    import { getFirestore, doc, runTransaction, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAyUuew-e4wlIdUDx7olNKx68sjD1UXY9U",
      authDomain: "iyal-survey.firebaseapp.com",
      projectId: "iyal-survey",
      storageBucket: "iyal-survey.appspot.com",
      messagingSenderId: "356060656195",
      appId: "1:356060656195:web:d0357a25774de984371af6",
      measurementId: "G-28XENM0B78"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const balance = document.getElementById("balance");
    const spinner = document.getElementById("balanceSpinner");
    const countdown = document.getElementById("countdown");

    let uid = null;

    onAuthStateChanged(auth, (user) => {
      if (!user) return (window.location.href = "login.html");
      uid = user.uid;

      const userRef = doc(db, "users", uid);
      onSnapshot(userRef, (snap) => {
        const data = snap.data();
        spinner.style.display = "none";
        balance.style.display = "inline";
        balance.textContent = `Balance: ₦${(data?.balance || 0).toLocaleString()}`;
      });

      initVideoAds();
    });

    function initVideoAds() {
      const player = videojs('ad-video');

      // Initialize IMA plugin
      player.ima({
        adTagUrl: 'https://s.magsrv.com/splash.php?idzone=5754436',
        debug: false,
        showCountdown: false
      });

      player.controls(false); // Disable controls until ad finishes

      player.ready(() => {
        player.ima.requestAds();
      });

      let adWatched = false;
      
      player.on('adstart', () => {
        adWatched = false;
        countdown.style.display = "flex";
      });

      player.on('adend', async () => {
        adWatched = true;
        countdown.style.display = "none";
        player.controls(true);

        // Update Firestore balance
        if (uid) {
          try {
            const userRef = doc(db, "users", uid);
            await runTransaction(db, async (transaction) => {
              const userDoc = await transaction.get(userRef);
              if (!userDoc.exists()) throw "User does not exist!";
              const currentBalance = userDoc.data().balance || 0;
              transaction.update(userRef, { balance: currentBalance + 25 });
            });
            showPopup("₦25 reward added!");
          } catch (err) {
            console.error("Failed to update balance:", err);
          }
        }
      });

      player.on('adskip', () => {
        adWatched = false;
        countdown.style.display = "none";
        player.controls(true);
        showPopup("You must watch the full ad to earn rewards.");
      });

      player.on('aderror', () => {
        adWatched = false;
        countdown.style.display = "none";
        player.controls(true);
        console.warn("Ad failed to load, skipping...");
      });

      // Optional: Update countdown every second
      let countdownInterval = setInterval(() => {
        if (!player.ads || !player.ads.isInAdMode()) {
          countdown.style.display = "none";
          clearInterval(countdownInterval);
          return;
        }
        const remaining = Math.ceil(player.ima.getRemainingTime() || 0);
        countdown.textContent = remaining;
      }, 500);
    }
  </script>
</body>
</html>