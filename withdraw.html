<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Withdraw – Iyal Surveys</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --green: #2e7d32;
  --light: #f1f8e9;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background: var(--light);
}

/* HEADER */
header {
  background: var(--green);
  color: white;
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-circle {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  overflow: hidden;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-circle img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.logo span {
  font-weight: 600;
  font-size: 1.1em;
}

/* CONTENT */
.content {
  padding: 16px;
  padding-bottom: 100px;
}

.card {
  background: white;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}

.card h2 {
  margin: 0 0 10px;
  color: var(--green);
  font-size: 1.15em;
}

.balance {
  font-size: 1.3em;
  font-weight: bold;
  color: var(--green);
}

.notice {
  background: #dcedc8;
  color: #33691e;
  padding: 12px;
  border-radius: 10px;
  font-size: .9em;
  margin-bottom: 16px;
}

/* FORM */
select, input {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1em;
}

button {
  width: 100%;
  margin-top: 14px;
  padding: 12px;
  background: var(--green);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}

button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

/* HISTORY */
.history-item {
  padding: 10px 0;
  border-bottom: 1px solid #eee;
  font-size: .9em;
}

.status-pending { color: orange; font-weight: 600; }
.status-approved { color: green; font-weight: 600; }
.status-rejected { color: red; font-weight: 600; }

/* BOTTOM NAV */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: var(--green);
  display: flex;
  justify-content: space-around;
  padding: 10px 0;
}

.bottom-nav a {
  color: white;
  text-decoration: none;
  font-size: .85em;
  text-align: center;
}

.bottom-nav i {
  display: block;
  font-size: 1.2em;
  margin-bottom: 4px;
}
</style>
</head>

<body>

<header>
  <div class="logo">
    <div class="logo-circle">
      <img src="assets/iyallogo.png" alt="Iyal Logo">
    </div>
    <span>Iyal Surveys</span>
  </div>
</header>

<div class="content">

  <div class="notice">
    Airtime: ₦2,000 • Bank: ₦5,000<br>
    Withdraw once every 24 hours. Manual approval.
  </div>

  <div class="card">
    <h2>Your Balance</h2>
    <div id="balance" class="balance">Loading...</div>
    <small id="cooldown"></small>
  </div>

  <div class="card">
    <h2>Withdraw</h2>

    <select id="method">
      <option value="">Select method</option>
      <option value="airtime">Airtime</option>
      <option value="bank">Bank Transfer</option>
    </select>

    <div id="airtimeForm" style="display:none;">
      <input id="phone" placeholder="Phone Number">
      <select id="network">
        <option value="">Select Network</option>
        <option>MTN</option>
        <option>Airtel</option>
        <option>Glo</option>
        <option>9mobile</option>
      </select>
    </div>

    <div id="bankForm" style="display:none;">
      <input id="bankName" placeholder="Bank Name">
      <input id="accountName" placeholder="Account Name">
      <input id="accountNumber" placeholder="Account Number">
    </div>

    <button id="withdrawBtn">Submit Withdrawal</button>
  </div>

  <div class="card">
    <h2>Recent Withdrawals</h2>
    <div id="history">Loading...</div>
  </div>

</div>

<div class="bottom-nav">
  <a href="dashboard.html"><i class="fa fa-home"></i>Home</a>
  <a href="withdraw.html"><i class="fa fa-money-bill"></i>Withdraw</a>
  <a href="login.html"><i class="fa fa-sign-out"></i>Logout</a>
</div>

<script>
/* ---------------- SUPABASE ---------------- */
const supabase = window.supabase.createClient(
  "https://xkshzlfducmnglxfnxzk.supabase.co",
  "YOUR_PUBLIC_ANON_KEY"
);

const ENDPOINT = "https://xkshzlfducmnglxfnxzk.supabase.co/functions/v1/clever-task";

/* ---------------- AUTH ---------------- */
const { data: { session } } = await supabase.auth.getSession();
if (!session) location.href = "login.html";

/* ---------------- UI ---------------- */
const method = document.getElementById("method");
const airtimeForm = document.getElementById("airtimeForm");
const bankForm = document.getElementById("bankForm");

method.onchange = () => {
  airtimeForm.style.display = method.value === "airtime" ? "block" : "none";
  bankForm.style.display = method.value === "bank" ? "block" : "none";
};

/* ---------------- LOAD DATA ---------------- */
async function loadDashboard() {
  const res = await fetch(ENDPOINT, {
    headers: {
      Authorization: `Bearer ${session.access_token}`
    }
  });

  const data = await res.json();

  document.getElementById("balance").textContent =
    "₦" + data.balance.toLocaleString();

  document.getElementById("cooldown").textContent =
    data.cooldown || "";

  renderHistory(data.history);
}

function renderHistory(items) {
  const h = document.getElementById("history");
  if (!items.length) {
    h.innerHTML = "<small>No withdrawals yet.</small>";
    return;
  }
  h.innerHTML = "";
  items.forEach(w => {
    h.innerHTML += `
      <div class="history-item">
        <strong>${w.type.toUpperCase()}</strong> – ₦${w.amount}<br>
        <small>${new Date(w.created_at).toLocaleString()}</small><br>
        <span class="status-${w.status}">${w.status}</span>
      </div>`;
  });
}

/* ---------------- WITHDRAW ---------------- */
document.getElementById("withdrawBtn").onclick = async () => {
  const payload = {
    method: method.value,
    phone: phone.value,
    network: network.value,
    bankName: bankName.value,
    accountName: accountName.value,
    accountNumber: accountNumber.value
  };

  const res = await fetch(ENDPOINT, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${session.access_token}`
    },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  alert(data.message || "Request sent");
  loadDashboard();
};

loadDashboard();
</script>

</body>
</html>
